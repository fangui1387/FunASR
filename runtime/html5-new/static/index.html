<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>FunASR è¯­éŸ³è¯†åˆ«</title>
    <link rel="stylesheet" href="css/style.css">
	<script src="./js/vconsole.min.js"></script>
</head>
<body>
    <div id="app" class="app-container">
        <!-- é…ç½®é¢æ¿ -->
        <div class="config-panel" id="configPanel">
            <div class="config-header">
                <h2>è¯­éŸ³è¯†åˆ«é…ç½®</h2>
                <button class="toggle-config-btn" id="toggleConfigBtn">
                    <span class="icon">âš™ï¸</span>
                </button>
            </div>
            <div class="config-content" id="configContent">
                <div class="config-item">
                    <label for="wsUrl">WebSocketæœåŠ¡å™¨åœ°å€:</label>
                    <input type="text" id="wsUrl" placeholder="ws://192.168.1.17:10095/" value="ws://192.168.1.17:10095/">
                    <div class="config-hint">æ”¯æŒ ws:// æˆ– wss:// åè®®</div>
                </div>
                <div class="config-item">
                    <label for="recognitionMode">è¯†åˆ«æ¨¡å¼:</label>
                    <select id="recognitionMode">
                        <option value="offline" selected>ç¦»çº¿æ¨¡å¼ (offline)</option>
                        <option value="2pass">ä¸¤éæ¨¡å¼ (2pass)</option>
                        <option value="online">å®æ—¶æ¨¡å¼ (online)</option>
                    </select>
                    <div class="config-hint">ç¦»çº¿æ¨¡å¼ï¼šå½•éŸ³ç»“æŸåè¯†åˆ«ï¼›ä¸¤éæ¨¡å¼ï¼šå®æ—¶+ç¦»çº¿ï¼›å®æ—¶æ¨¡å¼ï¼šæµå¼è¯†åˆ«</div>
                </div>
                <div class="config-item">
                    <label for="hotwords">çƒ­è¯é…ç½® (å¯é€‰):</label>
                    <textarea id="hotwords" rows="3" placeholder="é˜¿é‡Œå·´å·´ 20&#10;é€šä¹‰å®éªŒå®¤ 30"></textarea>
                    <div class="config-hint">æ¯è¡Œä¸€ä¸ªçƒ­è¯ï¼Œæ ¼å¼ï¼šçƒ­è¯ æƒé‡(1-100)</div>
                </div>
                <div class="config-item">
                    <label class="checkbox-label">
                        <input type="checkbox" id="useItn" checked>
                        <span>å¯ç”¨é€†æ–‡æœ¬æ ‡å‡†åŒ– (ITN)</span>
                    </label>
                </div>
                <div class="config-actions">
                    <button class="btn btn-primary" id="testConnectionBtn">æµ‹è¯•è¿æ¥</button>
                    <button class="btn btn-secondary" id="resetConfigBtn">é‡ç½®</button>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar" id="statusBar">
            <div class="status-indicator" id="statusIndicator"></div>
            <span class="status-text" id="statusText">å‡†å¤‡å°±ç»ª</span>
        </div>

        <!-- è¯†åˆ«ç»“æœåŒºåŸŸ -->
        <div class="result-panel">
            <div class="result-header">
                <h3>è¯†åˆ«ç»“æœ</h3>
                <button class="btn-icon" id="clearResultBtn" title="æ¸…ç©ºç»“æœ">ğŸ—‘ï¸</button>
            </div>
            <div class="result-content" id="resultContent">
                <div class="result-placeholder">è¯†åˆ«å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
            </div>
            <div class="result-meta" id="resultMeta"></div>
        </div>

        <!-- å½•éŸ³æ§åˆ¶åŒºåŸŸ -->
        <div class="record-panel" id="recordPanel">
            <!-- å½•éŸ³å‰ç•Œé¢ -->
            <div class="record-idle" id="recordIdle">
                <button class="record-btn" id="recordBtn">
                    <div class="record-btn-inner">
                        <svg class="mic-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                    </div>
                    <span class="record-btn-text">å¼€å§‹å½•éŸ³</span>
                </button>
                <div class="record-hint">ç‚¹å‡»æŒ‰é’®å¼€å§‹å½•éŸ³</div>
            </div>

            <!-- å½•éŸ³ä¸­ç•Œé¢ -->
            <div class="record-active" id="recordActive" style="display: none;">
                <div class="recording-indicator">
                    <div class="wave-container" id="waveContainer">
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                    </div>
                    <div class="recording-time" id="recordingTime">00:00</div>
                </div>
                <div class="recording-status">æ­£åœ¨å½•éŸ³...</div>
                <button class="record-stop-btn" id="recordStopBtn">
                    <div class="record-stop-btn-inner">
                        <svg class="stop-icon" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                        </svg>
                    </div>
                    <span class="record-stop-btn-text">åœæ­¢å½•éŸ³</span>
                </button>
            </div>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div class="error-toast" id="errorToast" style="display: none;">
            <div class="error-content">
                <span class="error-icon">âš ï¸</span>
                <span class="error-message" id="errorMessage"></span>
                <button class="error-close" id="errorCloseBtn">Ã—</button>
            </div>
        </div>

        <!-- åŠ è½½é®ç½© -->
        <div class="loading-mask" id="loadingMask" style="display: none;">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <div class="loading-text">æ­£åœ¨è¿æ¥...</div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å½•éŸ³æ ¸å¿ƒåº“ -->
    <script src="lib/recorder-core.js"></script>
    <!-- å¼•å…¥åº”ç”¨æ¨¡å— -->
    <script src="js/stateManager.js"></script>
    <script src="js/errorHandler.js"></script>
    <script src="js/wsClient.js"></script>
    <script src="js/audioRecorder.js"></script>
    <script src="js/app.js"></script>
	<script>
        // åˆå§‹åŒ– vConsoleï¼ˆä»…åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨ï¼‰
        const isDevEnvironment = location.hostname === 'localhost' ||
                                 location.hostname === '127.0.0.1' ||
                                 location.search.includes('debug=true');
        let vConsole = null;
        if (isDevEnvironment) {
            vConsole = new VConsole();
        }

        // ==========================================
        // FunASR SDK é›†æˆç¤ºä¾‹
        // å…¶ä»–H5é¡µé¢å¯ä»¥å‚è€ƒæ­¤é›†æˆæ–¹å¼
        // ==========================================

        // DOMå…ƒç´ å¼•ç”¨
        const elements = {
            wsUrl: document.getElementById('wsUrl'),
            recognitionMode: document.getElementById('recognitionMode'),
            hotwords: document.getElementById('hotwords'),
            useItn: document.getElementById('useItn'),
            configContent: document.getElementById('configContent'),
            toggleConfigBtn: document.getElementById('toggleConfigBtn'),
            recordBtn: document.getElementById('recordBtn'),
            recordStopBtn: document.getElementById('recordStopBtn'),
            recordIdle: document.getElementById('recordIdle'),
            recordActive: document.getElementById('recordActive'),
            recordingTime: document.getElementById('recordingTime'),
            statusIndicator: document.getElementById('statusIndicator'),
            statusText: document.getElementById('statusText'),
            resultContent: document.getElementById('resultContent'),
            resultMeta: document.getElementById('resultMeta'),
            loadingMask: document.getElementById('loadingMask'),
            errorToast: document.getElementById('errorToast'),
            errorMessage: document.getElementById('errorMessage'),
            errorCloseBtn: document.getElementById('errorCloseBtn'),
            clearResultBtn: document.getElementById('clearResultBtn'),
            testConnectionBtn: document.getElementById('testConnectionBtn'),
            resetConfigBtn: document.getElementById('resetConfigBtn')
        };

        // åˆ›å»º FunASRController å®ä¾‹
        const asrController = new FunASRController({
            wsUrl: elements.wsUrl.value,
            mode: elements.recognitionMode.value,
            itn: elements.useItn.checked
        });

        // å½•éŸ³è®¡æ—¶å™¨
        let recordingTimer = null;
        let recordingSeconds = 0;

        // ==========================================
        // äº‹ä»¶ç»‘å®šï¼šè¯†åˆ«ç»“æœ
        // ==========================================

        // å®æ—¶è¯†åˆ«ç»“æœ
        asrController.onResult((result) => {
            console.log('[ASR Result]', result);

            // è·å–å½“å‰æ¨¡å¼
            const currentMode = elements.recognitionMode.value;

            // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºç»“æœ
            if (currentMode === 'offline') {
                // offlineæ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤º
                setResultText(result.text || '', false);
            } else {
                // 2pass/onlineæ¨¡å¼ï¼šæ˜¾ç¤ºæ‹¼æ¥åçš„å®Œæ•´æ–‡æœ¬
                setResultText(result.fullText || '', true);
            }

            // æ›´æ–°å…ƒä¿¡æ¯
            elements.resultMeta.style.display = 'block';
            if (currentMode === '2pass') {
                elements.resultMeta.textContent = '2pass: å®æ—¶è¯†åˆ«ä¸­...';
            } else if (currentMode === 'online') {
                elements.resultMeta.textContent = 'online: å®æ—¶è¯†åˆ«ä¸­...';
            } else {
                elements.resultMeta.textContent = 'è¯†åˆ«ä¸­...';
            }
        });

        // è¯†åˆ«å®Œæˆ
        asrController.onComplete((result) => {
            console.log('[ASR Complete]', result);

            const currentMode = elements.recognitionMode.value;

            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            if (result.fullText || result.text) {
                setResultText(result.fullText || result.text || '', false);
            }

            // æ›´æ–°å…ƒä¿¡æ¯
            elements.resultMeta.style.display = 'block';
            if (currentMode === 'offline') {
                elements.resultMeta.textContent = 'âœ“ ç¦»çº¿è¯†åˆ«å®Œæˆ';
            } else if (currentMode === '2pass') {
                elements.resultMeta.textContent = 'âœ“ 2pass è¯†åˆ«å®Œæˆï¼ˆç¦»çº¿ç²¾è¯†åˆ«ï¼‰';
            } else if (currentMode === 'online') {
                elements.resultMeta.textContent = 'âœ“ å®æ—¶è¯†åˆ«å®Œæˆ';
            }

            // åœæ­¢å½•éŸ³UIï¼ˆä»…åœ¨é2passæ¨¡å¼ä¸‹ç«‹å³é‡ç½®ï¼Œ2passæ¨¡å¼ç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨åœæ­¢æˆ–å½•éŸ³è¶…æ—¶ï¼‰
            // 2passæ¨¡å¼ä¸‹ï¼Œcompleteäº‹ä»¶å¯èƒ½åªæ˜¯ä¸€å¥è¯çš„è¯†åˆ«å®Œæˆï¼Œä¸æ˜¯æ•´ä¸ªå½•éŸ³ç»“æŸ
            if (currentMode !== '2pass' && currentMode !== 'online') {
                stopRecordingUI();
            }
        });

        // é”™è¯¯å¤„ç†
        asrController.onError((error) => {
            console.error('[ASR Error]', error);
            showError(error.message || 'å‘ç”Ÿé”™è¯¯');
            stopRecordingUI();
        });

        // è¿æ¥çŠ¶æ€
        asrController.onConnecting(() => {
            updateStatus('connecting', 'è¿æ¥ä¸­...');
            showLoading();
        });

        asrController.onConnected(() => {
            updateStatus('connected', 'å·²è¿æ¥');
            hideLoading();
        });

        asrController.onDisconnected(() => {
            updateStatus('', 'æœªè¿æ¥');
        });

        // å½•éŸ³çŠ¶æ€
        asrController.onStart(() => {
            updateStatus('recording', 'æ­£åœ¨å½•éŸ³...');
            startRecordingUI();
        });

        asrController.onStop(() => {
            updateStatus('', 'å‡†å¤‡å°±ç»ª');
            stopRecordingUI();
        });

        // ==========================================
        // UIè¾…åŠ©å‡½æ•°
        // ==========================================

        function updateStatus(type, message) {
            elements.statusText.textContent = message;
            elements.statusIndicator.className = 'status-indicator ' + type;
        }

        function startRecordingUI() {
            elements.recordIdle.style.display = 'none';
            elements.recordActive.style.display = 'flex';
            recordingSeconds = 0;
            updateRecordingTime();
            recordingTimer = setInterval(() => {
                recordingSeconds++;
                updateRecordingTime();
            }, 1000);
        }

        function stopRecordingUI() {
            elements.recordIdle.style.display = 'flex';
            elements.recordActive.style.display = 'none';
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
        }

        function updateRecordingTime() {
            const mins = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
            const secs = (recordingSeconds % 60).toString().padStart(2, '0');
            elements.recordingTime.textContent = `${mins}:${secs}`;
        }

        function showLoading() {
            elements.loadingMask.style.display = 'flex';
        }

        function hideLoading() {
            elements.loadingMask.style.display = 'none';
        }

        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorToast.style.display = 'block';
            setTimeout(() => {
                elements.errorToast.style.display = 'none';
            }, 5000);
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') {
                return '';
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function sanitizeText(text) {
            if (typeof text !== 'string') {
                return '';
            }
            // ç§»é™¤æ½œåœ¨çš„å±é™©å­—ç¬¦å’Œæ§åˆ¶å­—ç¬¦
            return text.replace(/[<>]/g, '');
        }

        function setResultText(text, isRealtime) {
            const placeholder = elements.resultContent.querySelector('.result-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            let resultDiv = elements.resultContent.querySelector('.result-text');
            if (!resultDiv) {
                resultDiv = document.createElement('div');
                resultDiv.className = 'result-text';
                elements.resultContent.appendChild(resultDiv);
            }

            resultDiv.textContent = text;
            if (isRealtime) {
                resultDiv.style.color = '#667eea';
            } else {
                resultDiv.style.color = '';
            }
        }

        // ==========================================
        // UIäº‹ä»¶ç»‘å®š
        // ==========================================

        // é…ç½®é¢æ¿åˆ‡æ¢
        elements.toggleConfigBtn.addEventListener('click', () => {
            const isExpanded = elements.configContent.classList.toggle('expanded');
            elements.toggleConfigBtn.querySelector('.icon').textContent = isExpanded ? 'ğŸ”¼' : 'âš™ï¸';
        });

        // å¼€å§‹å½•éŸ³æŒ‰é’®
        elements.recordBtn.addEventListener('click', async () => {
            try {
                // æ›´æ–°é…ç½®
                asrController.setUrl(elements.wsUrl.value);
                asrController.setMode(elements.recognitionMode.value);
                asrController.updateConfig({
                    itn: elements.useItn.checked,
                    hotwords: elements.hotwords.value || null
                });

                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                elements.resultContent.innerHTML = '<div class="result-placeholder">è¯†åˆ«å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>';
                elements.resultMeta.style.display = 'none';

                // å¼€å§‹å½•éŸ³
                await asrController.startRecording();
            } catch (error) {
                showError(error.message);
            }
        });

        // åœæ­¢å½•éŸ³æŒ‰é’®
        elements.recordStopBtn.addEventListener('click', async () => {
            await asrController.stopRecording();
        });

        // æ¸…ç©ºç»“æœæŒ‰é’®
        elements.clearResultBtn.addEventListener('click', () => {
            elements.resultContent.innerHTML = '<div class="result-placeholder">è¯†åˆ«å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>';
            elements.resultMeta.style.display = 'none';
            asrController.clearResults();
        });

        // é”™è¯¯æç¤ºå…³é—­æŒ‰é’®
        elements.errorCloseBtn.addEventListener('click', () => {
            elements.errorToast.style.display = 'none';
        });

        // æµ‹è¯•è¿æ¥æŒ‰é’®
        elements.testConnectionBtn.addEventListener('click', async () => {
            try {
                asrController.setUrl(elements.wsUrl.value);
                asrController.setMode(elements.recognitionMode.value);
                await asrController.connect();
                updateStatus('connected', 'è¿æ¥æˆåŠŸ');
            } catch (error) {
                showError('è¿æ¥å¤±è´¥: ' + error.message);
            }
        });

        // é‡ç½®é…ç½®æŒ‰é’®
        elements.resetConfigBtn.addEventListener('click', () => {
            elements.wsUrl.value = 'ws://192.168.1.17:10095/';
            elements.recognitionMode.value = 'offline';
            elements.hotwords.value = '';
            elements.useItn.checked = true;
            
            asrController.setUrl(elements.wsUrl.value);
            asrController.setMode(elements.recognitionMode.value);
            asrController.updateConfig({
                itn: true,
                hotwords: null
            });
            
            updateStatus('', 'å‡†å¤‡å°±ç»ª');
        });

        // è¯†åˆ«æ¨¡å¼å˜æ›´
        elements.recognitionMode.addEventListener('change', () => {
            const mode = elements.recognitionMode.value;
            asrController.setMode(mode);
            
            const modeNames = {
                'offline': 'ç¦»çº¿æ¨¡å¼',
                '2pass': 'ä¸¤éæ¨¡å¼',
                'online': 'å®æ—¶æ¨¡å¼'
            };
            
            // æ˜¾ç¤ºæç¤º
            let toast = document.getElementById('toast-message');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast-message';
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 14px;
                    z-index: 9999;
                    pointer-events: none;
                    opacity: 0;
                    transition: opacity 0.3s;
                `;
                document.body.appendChild(toast);
            }
            toast.textContent = `å·²åˆ‡æ¢åˆ°${modeNames[mode] || mode}`;
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 2000);
        });
	</script>
</body>
</html>

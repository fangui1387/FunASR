<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>FunASR è¯­éŸ³è¯†åˆ«</title>
    <link rel="stylesheet" href="css/style.css">
	<script src="./js/vconsole.min.js"></script>
</head>
<body>
    <div id="app" class="app-container">
        <!-- é…ç½®é¢æ¿ -->
        <div class="config-panel" id="configPanel">
            <div class="config-header">
                <h2>è¯­éŸ³è¯†åˆ«é…ç½®</h2>
                <button class="toggle-config-btn" id="toggleConfigBtn">
                    <span class="icon">âš™ï¸</span>
                </button>
            </div>
            <div class="config-content" id="configContent">
                <div class="config-item">
                    <label for="wsUrl">WebSocketæœåŠ¡å™¨åœ°å€:</label>
                    <input type="text" id="wsUrl" placeholder="ws://192.168.1.17:10095/" value="ws://192.168.1.17:10095/">
                    <div class="config-hint">æ”¯æŒ ws:// æˆ– wss:// åè®®</div>
                </div>
                <div class="config-item">
                    <label for="recognitionMode">è¯†åˆ«æ¨¡å¼:</label>
                    <select id="recognitionMode">
                        <option value="offline" selected>ç¦»çº¿æ¨¡å¼ (offline)</option>
                        <option value="2pass">ä¸¤éæ¨¡å¼ (2pass)</option>
                        <option value="online">å®æ—¶æ¨¡å¼ (online)</option>
                    </select>
                    <div class="config-hint">ç¦»çº¿æ¨¡å¼ï¼šå½•éŸ³ç»“æŸåè¯†åˆ«ï¼›ä¸¤éæ¨¡å¼ï¼šå®æ—¶+ç¦»çº¿ï¼›å®æ—¶æ¨¡å¼ï¼šæµå¼è¯†åˆ«</div>
                </div>
                <div class="config-item">
                    <label for="hotwords">çƒ­è¯é…ç½® (å¯é€‰):</label>
                    <textarea id="hotwords" rows="3" placeholder="é˜¿é‡Œå·´å·´ 20&#10;é€šä¹‰å®éªŒå®¤ 30"></textarea>
                    <div class="config-hint">æ¯è¡Œä¸€ä¸ªçƒ­è¯ï¼Œæ ¼å¼ï¼šçƒ­è¯ æƒé‡(1-100)</div>
                </div>
                <div class="config-item">
                    <label class="checkbox-label">
                        <input type="checkbox" id="useItn" checked>
                        <span>å¯ç”¨é€†æ–‡æœ¬æ ‡å‡†åŒ– (ITN)</span>
                    </label>
                </div>
                <div class="config-actions">
                    <button class="btn btn-primary" id="testConnectionBtn">æµ‹è¯•è¿æ¥</button>
                    <button class="btn btn-secondary" id="resetConfigBtn">é‡ç½®</button>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar" id="statusBar">
            <div class="status-indicator" id="statusIndicator"></div>
            <span class="status-text" id="statusText">å‡†å¤‡å°±ç»ª</span>
        </div>

        <!-- è¯†åˆ«ç»“æœåŒºåŸŸ -->
        <div class="result-panel">
            <div class="result-header">
                <h3>è¯†åˆ«ç»“æœ</h3>
                <button class="btn-icon" id="clearResultBtn" title="æ¸…ç©ºç»“æœ">ğŸ—‘ï¸</button>
            </div>
            <div class="result-content" id="resultContent">
                <div class="result-placeholder">è¯†åˆ«å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
            </div>
            <div class="result-meta" id="resultMeta"></div>
        </div>

        <!-- å½•éŸ³æ§åˆ¶åŒºåŸŸ -->
        <div class="record-panel" id="recordPanel">
            <!-- å½•éŸ³å‰ç•Œé¢ -->
            <div class="record-idle" id="recordIdle">
                <button class="record-btn" id="recordBtn">
                    <div class="record-btn-inner">
                        <svg class="mic-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                    </div>
                    <span class="record-btn-text">å¼€å§‹å½•éŸ³</span>
                </button>
                <div class="record-hint">ç‚¹å‡»æŒ‰é’®å¼€å§‹å½•éŸ³</div>
            </div>

            <!-- å½•éŸ³ä¸­ç•Œé¢ -->
            <div class="record-active" id="recordActive" style="display: none;">
                <div class="recording-indicator">
                    <div class="wave-container" id="waveContainer">
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                    </div>
                    <div class="recording-time" id="recordingTime">00:00</div>
                </div>
                <div class="recording-status">æ­£åœ¨å½•éŸ³...</div>
                <button class="record-stop-btn" id="recordStopBtn">
                    <div class="record-stop-btn-inner">
                        <svg class="stop-icon" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                        </svg>
                    </div>
                    <span class="record-stop-btn-text">åœæ­¢å½•éŸ³</span>
                </button>
            </div>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div class="error-toast" id="errorToast" style="display: none;">
            <div class="error-content">
                <span class="error-icon">âš ï¸</span>
                <span class="error-message" id="errorMessage"></span>
                <button class="error-close" id="errorCloseBtn">Ã—</button>
            </div>
        </div>

        <!-- åŠ è½½é®ç½© -->
        <div class="loading-mask" id="loadingMask" style="display: none;">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <div class="loading-text">æ­£åœ¨è¿æ¥...</div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥åº”ç”¨æ¨¡å— -->
    <script src="js/stateManager.js"></script>
    <script src="js/errorHandler.js"></script>
    <script src="js/wsClient.js"></script>
    <script src="js/audioRecorder.js"></script>
    <script src="js/app.js"></script>
	<script>
        /**
         * ============================================================
         * FunASR Web SDK é›†æˆç¤ºä¾‹
         * ============================================================
         *
         * æœ¬æ–‡æ¡£æ¼”ç¤ºå¦‚ä½•åœ¨H5é¡µé¢ä¸­é›†æˆFunASRè¯­éŸ³è¯†åˆ«åŠŸèƒ½
         * å¼€å‘è€…å¯ä»¥å‚è€ƒæ­¤ç¤ºä¾‹å¿«é€Ÿæ¥å…¥SDK
         *
         * ã€æ¥å…¥æ­¥éª¤ã€‘
         * 1. å¼•å…¥å¿…è¦çš„JSæ–‡ä»¶ï¼ˆè§åº•éƒ¨scriptæ ‡ç­¾ï¼‰
         * 2. åˆ›å»º FunASRController å®ä¾‹
         * 3. ç»‘å®šäº‹ä»¶ç›‘å¬ï¼ˆonResult, onComplete, onErrorç­‰ï¼‰
         * 4. è°ƒç”¨ startRecording() å¼€å§‹å½•éŸ³
         * 5. è°ƒç”¨ stopRecording() åœæ­¢å½•éŸ³
         *
         * ã€æ ¸å¿ƒAPIã€‘
         * - new FunASRController(options)  : åˆ›å»ºSDKå®ä¾‹
         * - onResult(callback)             : ç›‘å¬å®æ—¶è¯†åˆ«ç»“æœ
         * - onComplete(callback)           : ç›‘å¬è¯†åˆ«å®Œæˆäº‹ä»¶
         * - onError(callback)              : ç›‘å¬é”™è¯¯äº‹ä»¶
         * - startRecording()               : å¼€å§‹å½•éŸ³
         * - stopRecording()                : åœæ­¢å½•éŸ³
         * - destroy()                      : é”€æ¯SDKå®ä¾‹ï¼ˆé¡µé¢å¸è½½æ—¶è°ƒç”¨ï¼‰
         *
         * ã€è¯†åˆ«æ¨¡å¼ã€‘
         * - offline : ç¦»çº¿æ¨¡å¼ï¼Œå½•éŸ³ç»“æŸåä¸€æ¬¡æ€§è¯†åˆ«ï¼Œå‡†ç¡®ç‡æœ€é«˜
         * - online  : å®æ—¶æ¨¡å¼ï¼Œè¾¹è¯´è¾¹è¯†åˆ«ï¼Œå®æ—¶æ€§å¥½
         * - 2pass   : ä¸¤éæ¨¡å¼ï¼Œå®æ—¶+ç¦»çº¿ç²¾ä¿®ï¼Œå…¼é¡¾å®æ—¶æ€§å’Œå‡†ç¡®ç‡
         *
         * è¯¦ç»†æ–‡æ¡£è¯·å‚è€ƒï¼šSDK_INTEGRATION.md
         * ============================================================
         */

        // ============================================================
        // ç¬¬ä¸€æ­¥ï¼šå¼€å‘ç¯å¢ƒè°ƒè¯•é…ç½®ï¼ˆå¯é€‰ï¼‰
        // ============================================================
        // vConsole æ˜¯ç§»åŠ¨ç«¯è°ƒè¯•å·¥å…·ï¼Œä»…åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨
        // ç”Ÿäº§ç¯å¢ƒå»ºè®®ç§»é™¤æˆ–ç¦ç”¨
        const isDevEnvironment = location.hostname === 'localhost' ||
                                 location.hostname === '127.0.0.1' ||
                                 location.search.includes('debug=true');
        let vConsole = null;
        if (isDevEnvironment) {
            vConsole = new VConsole();
            console.log('[FunASR] å¼€å‘ç¯å¢ƒå·²å¯ç”¨vConsoleè°ƒè¯•');
        }

        // ============================================================
        // ç¬¬äºŒæ­¥ï¼šè·å–DOMå…ƒç´ å¼•ç”¨
        // ============================================================
        // å°†é¡µé¢ä¸­éœ€è¦ç”¨åˆ°çš„DOMå…ƒç´ ç»Ÿä¸€ç®¡ç†ï¼Œæ–¹ä¾¿åç»­æ“ä½œ
        const elements = {
            // é…ç½®ç›¸å…³å…ƒç´ 
            wsUrl: document.getElementById('wsUrl'),                    // WebSocketæœåŠ¡å™¨åœ°å€è¾“å…¥æ¡†
            recognitionMode: document.getElementById('recognitionMode'), // è¯†åˆ«æ¨¡å¼ä¸‹æ‹‰æ¡†
            hotwords: document.getElementById('hotwords'),              // çƒ­è¯é…ç½®æ–‡æœ¬åŸŸ
            useItn: document.getElementById('useItn'),                  // ITNå¼€å…³
            configContent: document.getElementById('configContent'),    // é…ç½®é¢æ¿å†…å®¹åŒº
            toggleConfigBtn: document.getElementById('toggleConfigBtn'),// é…ç½®é¢æ¿åˆ‡æ¢æŒ‰é’®

            // å½•éŸ³æ§åˆ¶å…ƒç´ 
            recordBtn: document.getElementById('recordBtn'),            // å¼€å§‹å½•éŸ³æŒ‰é’®
            recordStopBtn: document.getElementById('recordStopBtn'),    // åœæ­¢å½•éŸ³æŒ‰é’®
            recordIdle: document.getElementById('recordIdle'),          // å½•éŸ³å‰ç•Œé¢
            recordActive: document.getElementById('recordActive'),      // å½•éŸ³ä¸­ç•Œé¢
            recordingTime: document.getElementById('recordingTime'),    // å½•éŸ³æ—¶é•¿æ˜¾ç¤º

            // çŠ¶æ€å’Œç»“æœå…ƒç´ 
            statusIndicator: document.getElementById('statusIndicator'),// çŠ¶æ€æŒ‡ç¤ºå™¨
            statusText: document.getElementById('statusText'),          // çŠ¶æ€æ–‡æœ¬
            resultContent: document.getElementById('resultContent'),    // è¯†åˆ«ç»“æœå†…å®¹åŒº
            resultMeta: document.getElementById('resultMeta'),          // è¯†åˆ«ç»“æœå…ƒä¿¡æ¯
            loadingMask: document.getElementById('loadingMask'),        // åŠ è½½é®ç½©

            // é”™è¯¯å’Œå·¥å…·å…ƒç´ 
            errorToast: document.getElementById('errorToast'),          // é”™è¯¯æç¤ºæ¡†
            errorMessage: document.getElementById('errorMessage'),      // é”™è¯¯æ¶ˆæ¯æ–‡æœ¬
            errorCloseBtn: document.getElementById('errorCloseBtn'),    // é”™è¯¯å…³é—­æŒ‰é’®
            clearResultBtn: document.getElementById('clearResultBtn'),  // æ¸…ç©ºç»“æœæŒ‰é’®
            testConnectionBtn: document.getElementById('testConnectionBtn'), // æµ‹è¯•è¿æ¥æŒ‰é’®
            resetConfigBtn: document.getElementById('resetConfigBtn')   // é‡ç½®é…ç½®æŒ‰é’®
        };

        // ============================================================
        // ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º FunASRController å®ä¾‹ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
        // ============================================================
        /**
         * FunASRController æ˜¯SDKçš„æ ¸å¿ƒç±»ï¼Œè´Ÿè´£ç®¡ç†è¯­éŸ³è¯†åˆ«å…¨æµç¨‹
         *
         * é…ç½®å‚æ•°è¯´æ˜ï¼š
         * - wsUrl    : WebSocketæœåŠ¡å™¨åœ°å€ï¼Œæ ¼å¼ä¸º ws://ip:port/ æˆ– wss://ip:port/
         * - mode     : è¯†åˆ«æ¨¡å¼ï¼Œå¯é€‰ 'offline' | 'online' | '2pass'
         * - itn      : æ˜¯å¦å¯ç”¨é€†æ–‡æœ¬æ ‡å‡†åŒ–ï¼ˆå°†æ•°å­—è½¬ä¸ºé˜¿æ‹‰ä¼¯æ•°å­—ï¼‰
         * - hotwords : çƒ­è¯é…ç½®ï¼Œæ ¼å¼ä¸º "çƒ­è¯ æƒé‡\nçƒ­è¯ æƒé‡"
         * - audioFs  : éŸ³é¢‘é‡‡æ ·ç‡ï¼Œé»˜è®¤16000ï¼ˆ16kHzï¼‰
         */
        const asrController = new FunASRController({
            wsUrl: elements.wsUrl.value,           // ä»è¾“å…¥æ¡†è·å–æœåŠ¡å™¨åœ°å€
            mode: elements.recognitionMode.value,  // ä»ä¸‹æ‹‰æ¡†è·å–è¯†åˆ«æ¨¡å¼
            itn: elements.useItn.checked           // ä»å¤é€‰æ¡†è·å–ITNè®¾ç½®
        });

        // å½•éŸ³è®¡æ—¶å™¨ç›¸å…³å˜é‡
        let recordingTimer = null;   // è®¡æ—¶å™¨å®ä¾‹
        let recordingSeconds = 0;    // å½•éŸ³ç§’æ•°

        // ============================================================
        // ç¬¬å››æ­¥ï¼šç»‘å®šSDKäº‹ä»¶ç›‘å¬ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
        // ============================================================
        // SDKé€šè¿‡äº‹ä»¶æœºåˆ¶å°†è¯†åˆ«çŠ¶æ€ã€ç»“æœç­‰é€šçŸ¥ç»™å¼€å‘è€…
        // å¼€å‘è€…éœ€è¦åœ¨å¯¹åº”çš„äº‹ä»¶å›è°ƒä¸­æ›´æ–°UI

        /**
         * onResult - å®æ—¶è¯†åˆ«ç»“æœå›è°ƒ
         * åœ¨è¯†åˆ«è¿‡ç¨‹ä¸­ä¼šæŒç»­è§¦å‘ï¼Œç”¨äºæ˜¾ç¤ºä¸­é—´è¯†åˆ«ç»“æœ
         *
         * resultå¯¹è±¡è¯´æ˜ï¼š
         * - result.text      : å½“å‰è¯†åˆ«çš„æ–‡æœ¬ç‰‡æ®µ
         * - result.fullText  : å®Œæ•´æ‹¼æ¥æ–‡æœ¬ï¼ˆ2pass/onlineæ¨¡å¼ä¸‹æœ‰æ•ˆï¼‰
         * - result.mode      : å½“å‰è¯†åˆ«æ¨¡å¼
         * - result.isFinal   : æ˜¯å¦ä¸ºæœ€ç»ˆç»“æœ
         */
        asrController.onResult((result) => {
            console.log('[ASR Result]', result);

            // è·å–å½“å‰é€‰æ‹©çš„è¯†åˆ«æ¨¡å¼
            const currentMode = elements.recognitionMode.value;

            // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºç»“æœ
            if (currentMode === 'offline') {
                // offlineæ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºå½“å‰è¯†åˆ«æ–‡æœ¬
                setResultText(result.text || '', false);
            } else {
                // 2pass/onlineæ¨¡å¼ï¼šæ˜¾ç¤ºæ‹¼æ¥åçš„å®Œæ•´æ–‡æœ¬ï¼ˆè“è‰²è¡¨ç¤ºå®æ—¶ï¼‰
                setResultText(result.fullText || '', true);
            }

            // æ›´æ–°å…ƒä¿¡æ¯æç¤º
            elements.resultMeta.style.display = 'block';
            if (currentMode === '2pass') {
                elements.resultMeta.textContent = '2pass: å®æ—¶è¯†åˆ«ä¸­...';
            } else if (currentMode === 'online') {
                elements.resultMeta.textContent = 'online: å®æ—¶è¯†åˆ«ä¸­...';
            } else {
                elements.resultMeta.textContent = 'è¯†åˆ«ä¸­...';
            }
        });

        /**
         * onComplete - è¯†åˆ«å®Œæˆå›è°ƒ
         * å½“ä¸€ä¸ªå¥å­æˆ–æ•´æ®µå½•éŸ³è¯†åˆ«å®Œæˆæ—¶è§¦å‘
         *
         * æ³¨æ„ï¼šåœ¨2pass/onlineæ¨¡å¼ä¸‹ï¼Œcompleteäº‹ä»¶å¯èƒ½åªæ˜¯ä¸€å¥è¯çš„è¯†åˆ«å®Œæˆ
         * ä¸æ˜¯æ•´ä¸ªå½•éŸ³ç»“æŸï¼Œæ‰€ä»¥ä¸ä¼šè‡ªåŠ¨åœæ­¢å½•éŸ³UI
         */
        asrController.onComplete((result) => {
            console.log('[ASR Complete]', result);

            const currentMode = elements.recognitionMode.value;

            // æ˜¾ç¤ºæœ€ç»ˆç»“æœï¼ˆé»‘è‰²è¡¨ç¤ºæœ€ç»ˆç»“æœï¼‰
            if (result.fullText || result.text) {
                setResultText(result.fullText || result.text || '', false);
            }

            // æ›´æ–°å…ƒä¿¡æ¯æç¤º
            elements.resultMeta.style.display = 'block';
            if (currentMode === 'offline') {
                elements.resultMeta.textContent = 'âœ“ ç¦»çº¿è¯†åˆ«å®Œæˆ';
            } else if (currentMode === '2pass') {
                elements.resultMeta.textContent = 'âœ“ 2pass è¯†åˆ«å®Œæˆï¼ˆç¦»çº¿ç²¾è¯†åˆ«ï¼‰';
            } else if (currentMode === 'online') {
                elements.resultMeta.textContent = 'âœ“ å®æ—¶è¯†åˆ«å®Œæˆ';
            }

            // ä»…åœ¨offlineæ¨¡å¼ä¸‹è‡ªåŠ¨åœæ­¢å½•éŸ³UI
            // 2pass/onlineæ¨¡å¼ä¸‹ç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨åœæ­¢æˆ–å½•éŸ³è¶…æ—¶
            if (currentMode !== '2pass' && currentMode !== 'online') {
                stopRecordingUI();
            }
        });

        /**
         * onError - é”™è¯¯å¤„ç†å›è°ƒ
         * å½“å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ï¼Œå¦‚ç½‘ç»œé”™è¯¯ã€æƒé™æ‹’ç»ç­‰
         */
        asrController.onError((error) => {
            console.error('[ASR Error]', error);
            showError(error.message || 'å‘ç”Ÿé”™è¯¯');
            stopRecordingUI();
        });

        // ============================================================
        // è¿æ¥çŠ¶æ€äº‹ä»¶
        // ============================================================

        /**
         * onConnecting - æ­£åœ¨è¿æ¥æœåŠ¡å™¨
         * æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œæç¤ºç”¨æˆ·æ­£åœ¨è¿æ¥
         */
        asrController.onConnecting(() => {
            updateStatus('connecting', 'è¿æ¥ä¸­...');
            showLoading();
        });

        /**
         * onConnected - è¿æ¥æˆåŠŸ
         * æ›´æ–°çŠ¶æ€ä¸ºå·²è¿æ¥ï¼Œéšè—åŠ è½½é®ç½©
         */
        asrController.onConnected(() => {
            updateStatus('connected', 'å·²è¿æ¥');
            hideLoading();
        });

        /**
         * onDisconnected - è¿æ¥æ–­å¼€
         * æ›´æ–°çŠ¶æ€ä¸ºæœªè¿æ¥
         */
        asrController.onDisconnected(() => {
            updateStatus('', 'æœªè¿æ¥');
        });

        // ============================================================
        // å½•éŸ³çŠ¶æ€äº‹ä»¶
        // ============================================================

        /**
         * onStart - å½•éŸ³å¼€å§‹
         * æ›´æ–°UIä¸ºå½•éŸ³ä¸­çŠ¶æ€
         */
        asrController.onStart(() => {
            updateStatus('recording', 'æ­£åœ¨å½•éŸ³...');
            startRecordingUI();
        });

        /**
         * onStop - å½•éŸ³åœæ­¢
         * æ›´æ–°UIä¸ºå°±ç»ªçŠ¶æ€
         */
        asrController.onStop(() => {
            updateStatus('', 'å‡†å¤‡å°±ç»ª');
            stopRecordingUI();
        });

        // ============================================================
        // ç¬¬äº”æ­¥ï¼šUIè¾…åŠ©å‡½æ•°
        // ============================================================
        // è¿™äº›å‡½æ•°ç”¨äºæ›´æ–°é¡µé¢UIï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚ä¿®æ”¹

        /**
         * æ›´æ–°çŠ¶æ€æ æ˜¾ç¤º
         * @param {string} type - çŠ¶æ€ç±»å‹ï¼š'connecting'|'connected'|'recording'|''
         * @param {string} message - çŠ¶æ€æ–‡æœ¬æ¶ˆæ¯
         */
        function updateStatus(type, message) {
            elements.statusText.textContent = message;
            elements.statusIndicator.className = 'status-indicator ' + type;
        }

        /**
         * åˆ‡æ¢åˆ°å½•éŸ³ä¸­UIçŠ¶æ€
         * - éšè—å½•éŸ³å‰ç•Œé¢
         * - æ˜¾ç¤ºå½•éŸ³ä¸­ç•Œé¢
         * - å¯åŠ¨å½•éŸ³è®¡æ—¶å™¨
         */
        function startRecordingUI() {
            elements.recordIdle.style.display = 'none';
            elements.recordActive.style.display = 'flex';
            recordingSeconds = 0;
            updateRecordingTime();
            // æ¯ç§’æ›´æ–°ä¸€æ¬¡å½•éŸ³æ—¶é•¿
            recordingTimer = setInterval(() => {
                recordingSeconds++;
                updateRecordingTime();
            }, 1000);
        }

        /**
         * åˆ‡æ¢åˆ°å½•éŸ³ç»“æŸUIçŠ¶æ€
         * - æ˜¾ç¤ºå½•éŸ³å‰ç•Œé¢
         * - éšè—å½•éŸ³ä¸­ç•Œé¢
         * - æ¸…é™¤å½•éŸ³è®¡æ—¶å™¨
         */
        function stopRecordingUI() {
            elements.recordIdle.style.display = 'flex';
            elements.recordActive.style.display = 'none';
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
        }

        /**
         * æ›´æ–°å½•éŸ³æ—¶é•¿æ˜¾ç¤º
         * æ ¼å¼ï¼šMM:SS
         */
        function updateRecordingTime() {
            const mins = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
            const secs = (recordingSeconds % 60).toString().padStart(2, '0');
            elements.recordingTime.textContent = `${mins}:${secs}`;
        }

        /**
         * æ˜¾ç¤ºåŠ è½½é®ç½©
         * åœ¨è¿æ¥æœåŠ¡å™¨æ—¶æ˜¾ç¤º
         */
        function showLoading() {
            elements.loadingMask.style.display = 'flex';
        }

        /**
         * éšè—åŠ è½½é®ç½©
         * è¿æ¥æˆåŠŸåéšè—
         */
        function hideLoading() {
            elements.loadingMask.style.display = 'none';
        }

        /**
         * æ˜¾ç¤ºé”™è¯¯æç¤º
         * @param {string} message - é”™è¯¯æ¶ˆæ¯
         * 5ç§’åè‡ªåŠ¨éšè—
         */
        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorToast.style.display = 'block';
            setTimeout(() => {
                elements.errorToast.style.display = 'none';
            }, 5000);
        }

        /**
         * HTMLè½¬ä¹‰å‡½æ•°
         * é˜²æ­¢XSSæ”»å‡»ï¼Œå°†ç‰¹æ®Šå­—ç¬¦è½¬ä¸ºHTMLå®ä½“
         * @param {string} text - åŸå§‹æ–‡æœ¬
         * @returns {string} è½¬ä¹‰åçš„HTML
         */
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                return '';
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * æ–‡æœ¬æ¸…ç†å‡½æ•°
         * ç§»é™¤æ½œåœ¨çš„å±é™©å­—ç¬¦
         * @param {string} text - åŸå§‹æ–‡æœ¬
         * @returns {string} æ¸…ç†åçš„æ–‡æœ¬
         */
        function sanitizeText(text) {
            if (typeof text !== 'string') {
                return '';
            }
            // ç§»é™¤æ½œåœ¨çš„å±é™©å­—ç¬¦å’Œæ§åˆ¶å­—ç¬¦
            return text.replace(/[<>]/g, '');
        }

        /**
         * è®¾ç½®è¯†åˆ«ç»“æœæ–‡æœ¬
         * @param {string} text - è¯†åˆ«ç»“æœæ–‡æœ¬
         * @param {boolean} isRealtime - æ˜¯å¦ä¸ºå®æ—¶ç»“æœï¼ˆå½±å“é¢œè‰²æ˜¾ç¤ºï¼‰
         *
         * å®ç°è¯´æ˜ï¼š
         * - ä½¿ç”¨textContentè€ŒéinnerHTMLï¼Œé˜²æ­¢XSSæ”»å‡»
         * - å®æ—¶ç»“æœæ˜¾ç¤ºä¸ºè“è‰²ï¼Œæœ€ç»ˆç»“æœæ˜¾ç¤ºä¸ºé»‘è‰²
         */
        function setResultText(text, isRealtime) {
            // ç§»é™¤å ä½ç¬¦
            const placeholder = elements.resultContent.querySelector('.result-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            // è·å–æˆ–åˆ›å»ºç»“æœå±•ç¤ºdiv
            let resultDiv = elements.resultContent.querySelector('.result-text');
            if (!resultDiv) {
                resultDiv = document.createElement('div');
                resultDiv.className = 'result-text';
                elements.resultContent.appendChild(resultDiv);
            }

            // ä½¿ç”¨textContentå®‰å…¨åœ°è®¾ç½®æ–‡æœ¬å†…å®¹
            resultDiv.textContent = text;

            // æ ¹æ®æ˜¯å¦å®æ—¶ç»“æœè®¾ç½®é¢œè‰²
            if (isRealtime) {
                resultDiv.style.color = '#667eea'; // è“è‰²è¡¨ç¤ºå®æ—¶ç»“æœ
            } else {
                resultDiv.style.color = ''; // é»˜è®¤é¢œè‰²è¡¨ç¤ºæœ€ç»ˆç»“æœ
            }
        }

        // ============================================================
        // ç¬¬å…­æ­¥ï¼šUIäº‹ä»¶ç»‘å®š
        // ============================================================
        // å°†ç”¨æˆ·æ“ä½œï¼ˆç‚¹å‡»æŒ‰é’®ç­‰ï¼‰ä¸SDKåŠŸèƒ½å…³è”

        /**
         * é…ç½®é¢æ¿åˆ‡æ¢
         * ç‚¹å‡»è®¾ç½®å›¾æ ‡å±•å¼€/æ”¶èµ·é…ç½®é¢æ¿
         */
        elements.toggleConfigBtn.addEventListener('click', () => {
            const isExpanded = elements.configContent.classList.toggle('expanded');
            elements.toggleConfigBtn.querySelector('.icon').textContent = isExpanded ? 'ğŸ”¼' : 'âš™ï¸';
        });

        /**
         * å¼€å§‹å½•éŸ³æŒ‰é’®ç‚¹å‡»äº‹ä»¶
         * æ ¸å¿ƒæµç¨‹ï¼š
         * 1. æ›´æ–°SDKé…ç½®ï¼ˆæœåŠ¡å™¨åœ°å€ã€æ¨¡å¼ã€çƒ­è¯ç­‰ï¼‰
         * 2. æ¸…ç©ºä¸Šä¸€æ¬¡çš„ç»“æœ
         * 3. è°ƒç”¨startRecording()å¼€å§‹å½•éŸ³
         */
        elements.recordBtn.addEventListener('click', async () => {
            try {
                // æ›´æ–°SDKé…ç½®
                asrController.setUrl(elements.wsUrl.value);
                asrController.setMode(elements.recognitionMode.value);
                asrController.updateConfig({
                    itn: elements.useItn.checked,
                    hotwords: elements.hotwords.value || null
                });

                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                elements.resultContent.innerHTML = '<div class="result-placeholder">è¯†åˆ«å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>';
                elements.resultMeta.style.display = 'none';

                // å¼€å§‹å½•éŸ³ï¼ˆSDKä¼šè‡ªåŠ¨å¤„ç†è¿æ¥ã€å½•éŸ³ã€è¯†åˆ«å…¨æµç¨‹ï¼‰
                await asrController.startRecording();
            } catch (error) {
                showError(error.message);
            }
        });

        /**
         * åœæ­¢å½•éŸ³æŒ‰é’®ç‚¹å‡»äº‹ä»¶
         * è°ƒç”¨stopRecording()åœæ­¢å½•éŸ³å¹¶å‘é€ç»“æŸä¿¡å·
         */
        elements.recordStopBtn.addEventListener('click', async () => {
            await asrController.stopRecording();
        });

        /**
         * æ¸…ç©ºç»“æœæŒ‰é’®ç‚¹å‡»äº‹ä»¶
         * æ¸…ç©ºé¡µé¢æ˜¾ç¤ºå’ŒSDKå†…éƒ¨ç¼“å­˜çš„ç»“æœ
         */
        elements.clearResultBtn.addEventListener('click', () => {
            elements.resultContent.innerHTML = '<div class="result-placeholder">è¯†åˆ«å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>';
            elements.resultMeta.style.display = 'none';
            asrController.clearResults();
        });

        /**
         * é”™è¯¯æç¤ºå…³é—­æŒ‰é’®
         */
        elements.errorCloseBtn.addEventListener('click', () => {
            elements.errorToast.style.display = 'none';
        });

        /**
         * æµ‹è¯•è¿æ¥æŒ‰é’®
         * ç”¨äºéªŒè¯WebSocketæœåŠ¡å™¨æ˜¯å¦å¯è¿æ¥
         * ä¸å¼€å§‹å½•éŸ³ï¼Œä»…æµ‹è¯•è¿æ¥
         */
        elements.testConnectionBtn.addEventListener('click', async () => {
            try {
                asrController.setUrl(elements.wsUrl.value);
                asrController.setMode(elements.recognitionMode.value);
                await asrController.connect();
                updateStatus('connected', 'è¿æ¥æˆåŠŸ');
            } catch (error) {
                showError('è¿æ¥å¤±è´¥: ' + error.message);
            }
        });

        /**
         * é‡ç½®é…ç½®æŒ‰é’®
         * å°†æ‰€æœ‰é…ç½®æ¢å¤ä¸ºé»˜è®¤å€¼
         */
        elements.resetConfigBtn.addEventListener('click', () => {
            // é‡ç½®UI
            elements.wsUrl.value = 'ws://192.168.1.17:10095/';
            elements.recognitionMode.value = 'offline';
            elements.hotwords.value = '';
            elements.useItn.checked = true;

            // åŒæ­¥æ›´æ–°SDKé…ç½®
            asrController.setUrl(elements.wsUrl.value);
            asrController.setMode(elements.recognitionMode.value);
            asrController.updateConfig({
                itn: true,
                hotwords: null
            });

            updateStatus('', 'å‡†å¤‡å°±ç»ª');
        });

        /**
         * è¯†åˆ«æ¨¡å¼å˜æ›´äº‹ä»¶
         * å½“ç”¨æˆ·åˆ‡æ¢è¯†åˆ«æ¨¡å¼æ—¶ï¼Œæ›´æ–°SDKé…ç½®å¹¶æ˜¾ç¤ºæç¤º
         */
        elements.recognitionMode.addEventListener('change', () => {
            const mode = elements.recognitionMode.value;
            asrController.setMode(mode);

            const modeNames = {
                'offline': 'ç¦»çº¿æ¨¡å¼',
                '2pass': 'ä¸¤éæ¨¡å¼',
                'online': 'å®æ—¶æ¨¡å¼'
            };

            // æ˜¾ç¤ºåˆ‡æ¢æç¤º
            let toast = document.getElementById('toast-message');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast-message';
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 14px;
                    z-index: 9999;
                    pointer-events: none;
                    opacity: 0;
                    transition: opacity 0.3s;
                `;
                document.body.appendChild(toast);
            }
            toast.textContent = `å·²åˆ‡æ¢åˆ°${modeNames[mode] || mode}`;
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 2000);
        });

        // ============================================================
        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æºï¼ˆé‡è¦ï¼‰
        // ============================================================
        /**
         * é¡µé¢å¸è½½å‰é”€æ¯SDKå®ä¾‹ï¼Œé‡Šæ”¾èµ„æº
         * é˜²æ­¢å†…å­˜æ³„æ¼å’ŒéŸ³é¢‘è®¾å¤‡å ç”¨
         */
        window.addEventListener('beforeunload', () => {
            if (asrController) {
                asrController.destroy();
            }
        });

        console.log('[FunASR] SDKåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ...');
	</script>
</body>
</html>
